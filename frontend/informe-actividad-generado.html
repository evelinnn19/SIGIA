<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SIGIA :: Informe de Actividad</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Fuente -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@200..800&display=swap"
      rel="stylesheet"
    />

    <!-- Favicon -->
    <link rel="shortcut icon" href="public/imgs/favicon.ico" type="image/x-icon" />

    <style>
      body { font-family: "Plus Jakarta Sans", system-ui, sans-serif; }
      /* scroll fino del contenedor tabla */
      .thin-scroll::-webkit-scrollbar { width: 10px; }
      .thin-scroll::-webkit-scrollbar-track { background: #a08f74; border-radius: 8px; }
      .thin-scroll::-webkit-scrollbar-thumb { background: #4D3C2D; border-radius: 8px; }
    </style>
  </head>

  <body class="bg-[#C5DBA7] text-[#4D3C2D] min-h-screen">
    <!-- Header -->
    <header class="bg-[#FDF2C5] px-6 py-5 flex items-center justify-between shadow-sm">
      <div class="flex items-center gap-3">
        <img src="imgs/LOGO.svg" alt="Logo Sigia" class="w-32 h-auto" />
      </div>
      <div class="flex items-center gap-3 bg-[#C5DBA7] px-5 py-2.5 rounded-full">
        <img src="imgs/logo-nodocente-encargado.svg" alt="No docente" class="w-8 h-8 rounded-full" />
        <span class="font-bold text-lg">No docente</span>
       <img src="imgs/icon-logout.svg"  onclick="window.location.href='index.html'"   class="cursor-pointer hover:scale-110 transition">
      </div>
    </header>

    <main class="px-6 md:px-8 pt-6 pb-14 max-w-[1120px] mx-auto">
      <!-- Título + metadata -->
      <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-2 mb-4">
        <h1 class="text-3xl md:text-4xl font-extrabold">Informe De Actividad</h1>
        <p id="filtrosLabel" class="text-sm md:text-base">
          <span class="font-extrabold">Filtros:</span> No se seleccionaron filtros
        </p>
      </div>
      <p id="periodoLabel" class="text-base md:text-lg mb-4">
        <span class="font-extrabold">Período Seleccionado:</span> —
      </p>

      <!-- Tabla -->
      <div class="border border-[#4D3C2D]/30">
        <div class="overflow-y-auto thin-scroll max-h-[420px]">
          <table id="tabla-actividad" class="w-full text-left text-sm md:text-base">
            <thead class="bg-[#4D3C2D] text-[#FDF2C5] sticky top-0">
              <tr>
                <th class="px-4 py-3 font-extrabold">Insumo</th>
                <th class="px-4 py-3 font-extrabold">Tipo</th>
                <th class="px-4 py-3 font-extrabold">Categoría</th>
                <th class="px-4 py-3 font-extrabold text-right">Cantidad</th>
                <th class="px-4 py-3 font-extrabold">Responsable</th>
              </tr>
            </thead>
            <tbody id="tbodyActividad" class="bg-[#6b5946] text-[#F0E5CD]">
              <!-- filas dinámicas -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- Acciones -->
      <section class="mt-8 rounded-2xl bg-[#FDF2C5] p-6 md:p-8 shadow-sm border border-[#4D3C2D]/10">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-8 mb-6">
          <!-- Descargar PDF -->
          <button
            id="btnPdf"
            type="button"
            class="flex items-center justify-center gap-3 py-4 px-6 rounded-full bg-[#FDF2C5] text-[#4D3C2D] shadow hover:shadow-md transition font-semibold text-[17px]"
          >
            <img src="/imgs/icon-download.svg" alt="" class="w-5 h-5 opacity-80" />
            Descargar en PDF
          </button>

          <!-- Descargar Excel (SIN bordes) -->
          <button
            id="btnExcel"
            type="button"
            class="flex items-center justify-center gap-3 py-4 px-6 rounded-full bg-[#FDF2C5] text-[#4D3C2D] shadow hover:shadow-md transition font-semibold text-[17px]"
          >
            <img src="imgs/icon-download.svg" alt="" class="w-5 h-5 opacity-80" />
            Descargar en Excel
          </button>
        </div>

        <div class="flex items-center justify-center gap-6">
          <a
            href="historial-movimientos.html"
            class="px-8 py-3 rounded-full bg-[#4D3C2D] text-white font-semibold hover:opacity-90 transition"
          >
            Realizar otra consulta
          </a>
          <button
            onclick="history.back()"
            class="px-8 py-3 rounded-full border-2 border-[#4D3C2D] font-semibold hover:bg-[#4D3C2D]/5 transition"
          >
            Volver
          </button>
        </div>
      </section>
    </main>

    <!-- LIBRERÍAS PARA EXPORTAR -->
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <script>
      // --- Helpers ---
      const $ = (sel) => document.querySelector(sel);
      const params = new URLSearchParams(location.search);

      function fmtFechaISOaHumana(iso) {
        if (!iso) return "";
        const [y, m, d] = iso.split("-");
        return `${d}/${m}/${y}`;
      }

      function setMetaInfo() {
        const desde = params.get("desde");
        const hasta = params.get("hasta");
        const tipo = params.get("tipo");
        const responsable = params.get("responsable");

        // Periodo
        const periodo = (desde || hasta)
          ? `Del ${fmtFechaISOaHumana(desde) || "—"} al ${fmtFechaISOaHumana(hasta) || "—"}`
          : "—";
        $("#periodoLabel").innerHTML =
          `<span class="font-extrabold">Período Seleccionado:</span> ${periodo}`;

        // Filtros
        const filtros = [];
        if (tipo && tipo !== "todos") filtros.push(`Tipo: ${capitalize(tipo)}`);
        if (responsable) filtros.push(`Responsable: ${responsable}`);
        $("#filtrosLabel").innerHTML =
          `<span class="font-extrabold">Filtros:</span> ${
            filtros.length ? filtros.join(" · ") : "No se seleccionaron filtros"
          }`;
      }

      function capitalize(s) {
        return s ? s.charAt(0).toUpperCase() + s.slice(1) : s;
      }

      function renderRows(rows) {
        const tbody = $("#tbodyActividad");
        if (!rows || rows.length === 0) {
          tbody.innerHTML = `
            <tr class="border-t border-[#F0E5CD]/20">
              <td colspan="5" class="px-4 py-4 italic text-[#F0E5CD]/80">
                No hay resultados para los filtros seleccionados.
              </td>
            </tr>`;
          return;
        }

        tbody.innerHTML = rows.map(r => `
          <tr class="border-t border-[#F0E5CD]/20">
            <td class="px-4 py-2">${r.insumo || "-"}</td>
            <td class="px-4 py-2">${r.tipo || "-"}</td>
            <td class="px-4 py-2">${r.categoria || "-"}</td>
            <td class="px-4 py-2 text-right">${r.cantidad ?? "-"}</td>
            <td class="px-4 py-2">${r.responsable || "-"}</td>
          </tr>
        `).join("");
      }

      // --- Carga de datos (API + fallback) ---
      async function cargarDatos() {
        setMetaInfo();

        const qs = params.toString(); // reusa los mismos params
        const url = `/api/informes/actividad${qs ? "?" + qs : ""}`;

        try {
          const res = await fetch(url, { headers: { "Accept": "application/json" } });
          if (!res.ok) throw new Error("HTTP " + res.status);
          const data = await res.json();
          // Se espera array de objetos: {insumo, tipo, categoria, cantidad, responsable}
          renderRows(Array.isArray(data) ? data : data?.items);
        } catch (err) {
          // Fallback de ejemplo (sacalo cuando el backend esté listo)
          console.warn("Usando datos mock por falta de backend:", err?.message || err);
          const mock = [
            { insumo: "fibras rojas", tipo: "Egreso", categoria: "Oficina", cantidad: 11, responsable: "Bedelia" },
            { insumo: "fibras azul",  tipo: "Egreso", categoria: "Oficina", cantidad: 12, responsable: "Bedelia" },
            { insumo: "tinta recarg.",tipo: "Egreso", categoria: "Oficina", cantidad: 6,  responsable: "Bedelia" },
            { insumo: "resma 70gr",   tipo: "Egreso", categoria: "Oficina", cantidad: 1,  responsable: "Analía Mendez" },
            { insumo: "resma 70g",    tipo: "Egreso", categoria: "Oficina", cantidad: 1,  responsable: "Ximena Villarreal" },
            { insumo: "resma A4",     tipo: "Egreso", categoria: "Oficina", cantidad: 1,  responsable: "Analía Mendez" },
            { insumo: "toner 285A",   tipo: "Egreso", categoria: "Oficina", cantidad: 1,  responsable: "Analía Mendez" },
            { insumo: "resma A4",     tipo: "Egreso", categoria: "Oficina", cantidad: 1,  responsable: "Coria Diego" },
            { insumo: "toner 205A",   tipo: "Egreso", categoria: "Oficina", cantidad: 1,  responsable: "Sec. Extensión" },
            { insumo: "caja clips",   tipo: "Egreso", categoria: "Oficina", cantidad: 1,  responsable: "Sec. Extensión" },
          ];
          renderRows(mock);
        }
      }

      // --------- EXPORTAR A PDF (cliente) ----------
      function exportarPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ orientation: 'p', unit: 'pt', format: 'a4' });

        const titulo = 'Informe de Actividad';
        const fecha  = new Date().toLocaleString();

        doc.setFont('helvetica', 'bold');
        doc.setFontSize(16);
        doc.text(titulo, 40, 40);
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(10);
        doc.text('Generado: ' + fecha, 40, 60);

        // Genera tabla desde el DOM
        doc.autoTable({
          html: '#tabla-actividad',
          startY: 80,
          styles: { fontSize: 9, cellPadding: 6 },
          headStyles: { fillColor: [77, 60, 45], textColor: [253, 242, 197] }, // paleta
          alternateRowStyles: { fillColor: [253, 242, 197] }, // crema
          didDrawPage: (data) => {
            const pageCount = doc.internal.getNumberOfPages();
            const pageSize = doc.internal.pageSize;
            const pageWidth = pageSize.getWidth();
            doc.setFontSize(9);
            doc.text(
              `Página ${data.pageNumber} de ${pageCount}`,
              pageWidth - 100,
              pageSize.getHeight() - 20
            );
          }
        });

        doc.save('informe_actividad.pdf');
      }

      // --------- EXPORTAR A EXCEL (cliente) ----------
      function exportarExcel() {
        const tabla = document.getElementById('tabla-actividad');
        const ws = XLSX.utils.table_to_sheet(tabla, { raw: true });
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Actividad');
        XLSX.writeFile(wb, 'informe_actividad.xlsx');
      }

      // Wire botones
      function wireDescargasCliente() {
        $('#btnPdf').addEventListener('click', exportarPDF);
        $('#btnExcel').addEventListener('click', exportarExcel);
      }

      // Init
      cargarDatos().then(wireDescargasCliente);
    </script>
  </body>
</html>
